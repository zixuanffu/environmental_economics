# Dynamic choice modeling

Even though I have written it many many times, the myriad of notations can still be confusing and call for some clarifications.

## Reward function 
$$u(s, a) $$
## Total reward function
$$v(s, a, \epsilon) = u(s, a) + \epsilon_a$$

## Continuation reward function
$$\tilde{u}(s, a) = u(s, a) +  \beta E_{(s',\epsilon')\mid (a, s, \epsilon)} V(s',\epsilon') $$

## Continuation total reward function
$$\tilde{v}(s, a , \epsilon)  = \tilde{u}(s, a) + \epsilon_a$$

## Value function 
$$V(s, \epsilon) = \max_{a} \tilde{v}(s, a , \epsilon)$$

## Expected value function
$$\bar{V}(s) = \int_{\epsilon} V(s, \epsilon) dF(\epsilon)$$

## Conditional independence assumption
Thanks to the following assumption, 
$$f((s', \epsilon')\mid (a, s, \epsilon)) = f(\epsilon')f(s'\mid (a, s))$$
we have the relationship between value function and expected value function:

$$ \bar{V}(s) = \int_{\epsilon} \left [\underbrace{\underbrace{
 \max_{a}u(s, a) + \beta  E_{s'\mid (a, s)} \bar{V}(s')}_{\tilde{u}(s,a)} + \epsilon_a}_{\tilde{v}(s,a,\epsilon)}\right] dF(\epsilon)$$

which is used to sovle for the expected value function by solving for the fixed point of the following operator.

# Dynamic choice estimation

## Finite horizon CCP estimation

First we need to rewrite the expected value function in terms of CCP
### Approach 1
$$\bar{V}(s) = \sum_{a} \Pr(a\mid s) \left [u(s, a) + E(\epsilon_a|s,a)+\beta E_{s'\mid (a, s)} \bar{V}(s')\right]$$
$$ = \sum_{a} \Pr(a\mid s) \left [\tilde{u}(s,a) + \gamma - \ln \Pr(a\mid s) \right]$$
Because we have 
$$ E(\epsilon_a|s,a) = \frac{1}{\Pr(a\mid s)} \int \epsilon_a 1\left\{\tilde{u}(s,a) + \epsilon_a > \tilde{u}(s,a')+\epsilon_{a'} \right\}dF(\epsilon)$$
And in the case of T1EV, 
$$ E(\epsilon_a|s,a) = \gamma - \ln \Pr(a\mid s)$$
### Approach 2
$$\bar{V}(s) = \int \max_{a} \left [u(s, a) +\epsilon_a+\beta E_{s'\mid (a, s)} \bar{V}(s')\right] dF(\epsilon)$$
$$ = \gamma + \ln \sum_{a'} \exp\left(\tilde{u}(s,a') \right)$$
At the same time, we have
$$ \Pr(a\mid s) = \frac{\exp(\tilde{u}(s,a))}{\sum_{a'} \exp(\tilde{u}(s,a'))}$$
Then we can rewrite the expected value function in terms of CCP of a particular action $a$ as follows:
$$ \bar{V}(s) = \gamma + \ln \exp(\tilde{u}(s,a)) - \ln \Pr(a\mid s)$$
$$ = \tilde{u}(s,a) - \ln \Pr(a\mid s)+ \gamma $$ 

**Remark** How to show the two approaches are equivalent? 

Comparing 
$$\sum_{a} \Pr(a\mid s) \left [\tilde{u}(s,a) + \gamma - \ln \Pr(a\mid s) \right]$$
with 
$$\tilde{u}(s,a) - \ln \Pr(a\mid s)+ \gamma$$

Notice that 
$$ \ln \Pr(a\mid s) = \tilde{u}(s,a) - \ln \sum_{a'} \exp\left(\tilde{u}(s,a') \right)$$
The proof is done.


